<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
    
<%@page import="com.guardias.*"%>
<%@page import="java.util.*"%>        
    
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<title>Distribución Guardias Médicos Inicio </title>
<link href='<%=request.getContextPath()%>/css/jquery-ui.css' rel='stylesheet' />
<link href='<%=request.getContextPath()%>/css/fullcalendar.css' rel='stylesheet' />
<link href='<%=request.getContextPath()%>/css/fullcalendar.print.css' rel='stylesheet' media='print' />
<link href='<%=request.getContextPath()%>/css/custom.css?ffddd4' rel='stylesheet'/>
<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
<script src='<%=request.getContextPath()%>/js/lib/moment.min.js'></script>
<script src='<%=request.getContextPath()%>/js/lib/jquery.min.js'></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src='<%=request.getContextPath()%>/js/fullcalendar.min.js'></script>
<script src='<%=request.getContextPath()%>/js/locale-all.js'></script>



<script>  var obj = {};</script>

<%

	String _PageToFill="guardias_mes.jsp";

	//System.out.println(request.getParameter("festivo1"));


	if (request.getParameter("fecha")!=null) 
			
			_PageToFill="fill_agenda.jsp";
	
	if (request.getParameter("start_calc")!=null)  // se rellena con los huecos  
	{
		_PageToFill="calc_agenda.jsp";
		
		if (request.getParameter("festivo1")!=null)
		{%>
			<script>
						obj["start_calc"] = '<%=request.getParameter("start_calc")%>';	
						obj["end_calc"] = '<%=request.getParameter("end_calc")%>';
		   </script>
	<%
			for (int j=1;j<=31;j++)
			{
				String _param = "poolday" + j;
				String _param1 = "festivo" + j;
				//out.println (request.getParameter(_param1));
				if (request.getParameter(_param1)!=null)
				{
%>
					<script>
						obj["poolday<%=j%>"] = '<%=request.getParameter(_param)%>';	
						obj["festivo<%=j%>"] = '<%=request.getParameter(_param1)%>';
					</script>
<%
				}
				
				
			}
		}
		
	
	}	
%>


<script>

function _FillDataDays()
{
	$( "#doctor_list li div.fullname" ).each(function( index ) { 
	    
		
		
		
		Guardias = $("div.adjunto[id=" + $(this).attr("id") +"]").length;
		var ID_INICIAL = $(this).attr("id");
		console.log("Id Medico:" + ID_INICIAL);
		Festivo =0; 
		ID = -1;
		$( ".fc-title" ).each(function( index ) 
		{ 		
		       
			  ID = $(this).find("div.adjunto").attr("id");
			  //console.log("IdMedico dentro de cada dia:" + ID + ",IDPREVIO" + ID_INICIAL);
			  //console.log($(this).find(".festivoc").attr("checked"));
		      if ($(this).find(".festivoc")!=null && ID == ID_INICIAL)
					Festivo +=1;
			  //console.log("IDDENTRO:" + ID  + ",festivo:" + Festivo);

		});    
		console.log("festivos:" + Festivo);
		if (ID!=-1)
		{	
			//alert($(this).find("div").html());
			$(ID_INICIAL + "_data").html("Total Guardias:" + Guardias + ",Festivos:" + Festivo);
			//alert($(ID_INICIAL + "_data").html());
		}	
	});

}

/* rellenamos los datos totales	
$( document ).ready(function() {
$( "#doctor_list li div.fullname" ).each(function( index ) { 
    
	
	
	
	Guardias = $("div.adjunto[id=" + $(this).attr("id") +"]").length;
	var ID_INICIAL = $(this).attr("id");
	console.log(ID_INICIAL);
	Festivo =0; 
	ID = -1;
	$( ".fc-title" ).each(function( index ) 
	{ 		
	       
		  ID = $(this).find("div.adjunto").attr("id");
		  console.log("IDDENTRO:" + ID);
	      if ($(this).find(".festivo input").attr("checked")!=null && ID == ID_INICIAL)
				Festivo +=1;
		  console.log("IDDENTRO:" + ID  + ",festivo:" + Festivo);

	});    
	console.log("festivos:" + Festivo);
	if (ID!=-1)
		$(this).append("<div class=\"info\">Total Guardias:" + Guardias + ",Festivos:" + Festivo + "</div>")
});
});*/

	/* AJAX CALL FOR DOCTOR LIST 
	function fn_callDoctorList() {*/
		
	$( document ).ready(function() {			
        $.ajax({	            
            type: 'GET',
            url: '<%=request.getContextPath()%>/ajax/doctor_list.jsp',
            success: function(data) {   
                $('#doct_list').html(data);
                fn_callOrdenDoctorList();
            }
        });
	});	
		
		
	/* } */
	

	function fn_callOrdenDoctorList() {	
		$( "#doctor_list" ).sortable({
		    axis: 'y',
		    update: function (event, ui) {
		        var data = $( "#doctor_list" ).sortable('serialize');

		        //alert(data);
		        
		        // POST to server using $.post or $.ajax
		        $.ajax({
		            data: data,
		            type: 'POST',
		            url: '<%=request.getContextPath()%>/medico/medico_orden.jsp',
		        });
		    }
		});
		
		$( "#doctor_list" ).disableSelection();
	} 
	
	//);

	
	
	
	
	var _DateClicked= "";
	var _EventToChange;

	
	
	
	
	function fn_Save(){
		
		  
		  
		  var _myindex = 1;
		 
		  var obj = {};
		  
		  
		  $('<input>').attr({
			    type: 'hidden',
			    id: 'start_calc',
			    name: 'start_calc',
			    value: $('#calendar').fullCalendar('getDate').format("YYYY-MM-DD")
			}).appendTo('#fSave');

		 /*  obj["start"] = $('#calendar').fullCalendar('getDate').format("YYYY-MM-DD");
		  obj["end"] = $('#calendar').fullCalendar('getDate').format("YYYY-MM-DD");
		  */
		  $('<input>').attr({
			    type: 'hidden',
			    id: 'end_calc',
			    name: 'end_calc',
			    value: $('#calendar').fullCalendar('getDate').format("YYYY-MM-DD")
			}).appendTo('#fSave');		  		 

		  	  
		  $('.fc-title').each(function( index ) {
			  // obtenemos el #residente #tipo A / B
			  var _Tipo= $(this).find("#poolday #pool:checked");
			 // alert(_Tipo);
			  // obtenemos si es festivo
			  var _Festivo= $(this).find(".festivo input");
			  
			  
			  //console.log( $(this).find(".festivo input:checked"));
			  
			  $('<input>').attr({
				    type: 'hidden',				    
				    name: 'poolday' + _myindex,
				    value: _Tipo.val()
			  
				}).appendTo('#fSave');
			  
			  	//obj["tipo" + _myindex] = _Tipo.val();
			  
			  			  
			//  _GET_DATA += ",tipo" + _myindex + "=" _Tipo.val();
			  var _festivoValue = false;
			  if ($(_Festivo).is(':checked')) {  
			  //if (_Festivo.val()=="V")
				  _festivoValue = true;
			  }		  
			  
			  $('<input>').attr({
				    type: 'hidden',				    
				    name: 'festivo' + _myindex,
				    value: _festivoValue
			  
				}).appendTo('#fSave');
			  
			  
			  //obj["festivo" + _myindex] = _festivoValue;
			  _myindex++;
			//  console.log( index + ": " + $( this ).text() );
			});
		  
		  
		  $("#fSave").submit();
		  

	}
	
	
	function fn_Excel()
	{
		
		$("#filecontent").val($(".fc table").html());		
		$("#ff3").submit();
		
	
	}
	

	function fn_FillMonth(){
		
				
		// todos seleccionados
		
		var _pageTo = "<%=request.getRequestURI()%>";
		$("#fecha").val($('#calendar').fullCalendar('getDate').format());
		//alert($("#fecha").val());
		//$("#ff").submit();		

		
	}

	$(document).ready(function() {
		
		$('#calendar').fullCalendar({
			header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,agendaWeek,agendaDay,listWeek'
			},
		//	defaultDate: '2016-09-19',
			navLinks: true, // can click day/week names to navigate views
			editable: true,
			eventLimit: true, // allow "more" link when too many events
			color: "yellow",   // an option!
		    textColor: "black", // an option!
		    locale: 'es',
			events:   {
				url: '<%=_PageToFill%>',
				//method : 'post',
				data : obj,
				error: function() {
					$('#script-warning').show();
				}
			},
			 loading: function (bool) {
				if (bool) 
					    $('#loading').show();
					  else 
					    $('#loading').hide();
			 } ,
			    eventAfterAllRender: function (view) {
			    	_FillDataDays(); 
			    },
			    eventRender: function (event, element) {
			    	element.find('.fc-title').html(event.title);
			    }
		});
		
	});

</script>
</head>
<body>

	
	<div id="wrapper">
	<div id='calendar'></div>
	<div  id='doct_list'> 
						
	</div>
	<form  id=ff method=post onsubmit="return  fn_FillMonth()">
		<input type="text" name="fecha" id=fecha value='2016-09-10'/>
		<input  class="ui-button ui-widget ui-corner-all" type="submit" value="Resetear Mes"/>
	</form>
	
	<form  id=ff2 method=post onsubmit="return  fn_FillMonth()">
		<input  class="ui-button ui-widget ui-corner-all" type="submit" value="Guardar"/>
	</form>
	
	<form target="frame1" id=ff3 method=post action="toExcel.jsp">
		<input type="hidden" id="filecontent" name="filecontent">
		<input  class="ui-button ui-widget ui-corner-all" onclick="fn_Excel()" type="button" value="Descargar Excel"/>
	</form>
	
	<div id='fill'></div>
	<div id="loading" class="progress" style="display:none">
	  <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
	    <span class="sr-only">100% Complete</span>
	  </div>
	</div>
	
    
    <ul>
    <li class="presencia">Presencia</li>
    <li class="refuerzo">Refuerzo</li>
    <li class="localizada">Localizada</li>
    <li></li>
    </ul>
    
    <form name="fSave" id=fSave method ="POST"><input class="ui-button ui-widget ui-corner-all" type="button" onclick="fn_Save()" value="Calcular Guardias "/></form></div> </div></p>
	</div>
	
	<div id="frame1"></div>

</body>
</html>